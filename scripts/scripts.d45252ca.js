(function(){"use strict";angular.module("xmlFiestaUiApp",["ngAnimate","ngCookies","ngResource","ui.router","ngSanitize","ngTouch","pdf","LocalStorageModule","pascalprecht.translate"]).config(["localStorageServiceProvider","$translateProvider","$compileProvider","TRANSLATIONS_EN","TRANSLATIONS_ES",function(a,b,c,d,e){return a.setPrefix("XMLFiesta"),b.translations("en",d).translations("es",e).preferredLanguage("es").fallbackLanguage("en"),c.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|blob):/)}]).config(["$stateProvider","$urlRouterProvider",function(a,b){return a.state("verify",{url:"/",templateUrl:"views/verify.html",controller:"VerifyCtrl",controllerAs:"verify"}).state("how",{url:"/how",templateUrl:"views/how.html",controller:"HowCtrl",controllerAs:"how"}).state("config",{url:"/config",templateUrl:"views/config.html",controller:"ConfigCtrl",controllerAs:"config"}),b.otherwise("/")}])}).call(this),function(){angular.module("xmlFiestaUiApp").constant("TRANSLATIONS_ES",{HEADER:{HOME:"¿Cómo Funciona?",VERIFY:"Verificar XML",FAQ:"¿Cómo Funciona?",CONTACT:"Contacto",CONFIG:"Configuración"},VERIFY:{TITLE:"¿Cómo Funciona?",ROOT:"Carga los certificados raíz correspondientes. Actualmente este validador sólo funciona con certificados emitidos por el SAT de México.",XML:"Carga el archivo XML que quieras verificar. El archivo XML contiene toda la información necesaria para realizar esta verificación.",VALIDATION:"El sistema realizará las validaciones necesarias. Es necesario que todas sean exitosas para garantizar la legitimidad del documento.",GET_STARTED:"Comienza Ahora",DRAG:"Arrastra el XML que quieras verificar",SELECT:"o haz click aquí para seleccionar uno",VALIDATIONS:"Validaciones",REMINDER:"Asegúrate de revisar que ninguno de los campos muestre un error (tache rojo). En ausencia de errores puedes estar seguro de que el documento fue firmado correctamente.",DOCUMENT_NAME:"Documento",ORIG_HASH:"Hash Original ",WHY:"¿Por qué?",WRONG_HASH:"El hash calculado no coincide con el hash del documento original. El documento original fue cambiado o se está usando el hash de otro documento.",SIGNER:"Firmante",ID:"RFC",SIG_DATE:"Fecha de Firma",CERT_NUMBER:"Núm de Certificado ",REVIEW:"A continuación puedes revisar el documento que fue firmado.",NEW_DOC:"Validar otro documento",SIGNATURE:"Firma ",WRONG_CERT:"El certificado no fue firmado con ninguno de los certificados raíz que cargaste en la página de configuración. Asegúrate de haber cargado todos los certificados raíz de la autoridad que emitió el certificado usado para firmar. Si este error persiste significa que el certificado no fue emitido por la autoridad certificadora dueña de los certificados raíz.",WRONG_SIG:"La Firma no es válida, pudo haber sido modificada o no se usó la llave privada correspondiente al certificado mencionado anteriormente.",LOADING:"Validando documento...",CONSERVANCY_RECORD:"Constancia de conservación",RECORD:{ISSUER:"Emisor",TIMESTAMP:"Fecha",VALIDITY:"Validez",WRONG_TS:"La fecha del XML ({{xmlTS}}) no coincide con la fecha de la constancia de conservación ({{recordTS}}).",WRONG_CR:"La constancia de conservación en el XML no está presente o no tiene una esctructura válida.",WRONG_ARCHIVE:"El documento o las firmas han sido modificados desde la emisión de la constancia.",VALID_ARCHIVE:"La constancia de conservación coincide con documento y firmas."}},FAQ:{ABOUT:"Acerca de",INTRO:"XML Fiesta es una herramienta para validar Firmas Electrónicas Avanzadas.",NOTICE:"*Esta versión soporta únicamente documentos firmados usando la FIEL (eFirma) del SAT a través de la plataforma de ",HOW:"¿Cómo Funciona?",FIRST:"1. Cargar los certificados raíz de la autoridad certificadora (ej. SAT) que emitió los certificados con los que se firmó el documento.",SECOND:"2. Seleccionar o arrastrar el documento firmado (en formato XML).",THIRD:"3. La aplicación realizará tres validaciones y si se cumplen todas podrás estar 100% seguro de que tienes un documento firmado correctamente por la persona o personas indicadas otorgándole todo el valor legal que la ley le confiere a los documentos firmados mediante Firmas Electrónicas Avanzadas.",WHAT:"¿Qué valida esta aplicación?",VALIDATION_1:"1. Que la huella digital o hash del documento original (PDF) sea la correcta.",VALIDATION_2:"2. Que los certificados que se usaron para firmar no sean apócrifos.",VALIDATION_3:"3. Que la Firma Electrónica corresponda al documento que se firmó.",QUESTIONS:"¿Dudas o preguntas?",EMAIL:"Envíanos un correo"},FOOTER:{MADE:"Hecho ",MADE2:"por el equipo de ",SOURCE_CODE:"Ver código fuente"},CONFIG:{CERTIFICATES_LOADED:"¿Haz cargado todos los Certificados Raíz?",VER_BUTTON:"Proceder a verificar",SELECT:"Carga los Certificados Raíz",ALL:"Asegúrate de seleccionar todos los certificados raíz correspondientes a la autoridad certificadora. Puedes seleccionar varios certificados a la vez.",AFTER:"Una vez que hayas cargado los certificados raíz verás un botón que te permitirá seguir con el proceso de validación de un archivo XML.",LOADED:"Certificados Raíz que has cargado",DELETE:"Borrar todos los certificados ",UNDONE:"(Está acción no puede ser revertida, tendrás que cargarlos de nuevo)"}})}.call(this),function(){angular.module("xmlFiestaUiApp").constant("TRANSLATIONS_EN",{HEADER:{HOME:"Home",VERIFY:"Verify XML",CONTACT:"Contact",CONFIGURATION:"Configuration"}})}.call(this),function(){"use strict";angular.module("xmlFiestaUiApp").controller("MainCtrl",function(){})}.call(this),function(){"use strict";angular.module("xmlFiestaUiApp").controller("VerifyCtrl",["$scope","$q","$timeout","$filter","localStorageService",function(a,b,c,d,e){var f,g,h;PDFJS.workerSrc="scripts/pdf.worker.js",f=function(){var b,c;a.certs=[],a.nom151Ca=[],b=e.get("rootCerts"),c=e.get("nom151Ca"),c&&angular.forEach(c,function(b){return a.nom151Ca.push(b)}),b&&angular.forEach(b,function(b){return a.certs.push(b)})},f(),a.clear=function(){a.ready=a.certs.length>0,a.upload=null,a.doc=null,a.pdfUrl=null,a.loading=!1,angular.element(".file-upload-input").val("")},a.clear(),g=function(){return a.doc.recordPresent&&a.record instanceof XMLFiesta.ConservancyRecord?(a.record.valid=a.record.valid(),a.record.validTS=a.record.equalTimestamps(),a.record.validCA=!1,a.record.validArchive=a.record.validArchiveHash(),angular.forEach(a.nom151Ca,function(b){a.record.validCA||(a.record.validCA=a.record.isCa(b.content))}),a.record.tsTranslation={recordTS:d("date")(a.record.recordTimestamp(),"medium","UTC"),xmlTS:d("date")(Date.parse(a.record.timestamp),"medium","UTC")}):a.doc.recordPresent&&a.doc.errors.recordInvalid?a.record={valid:!1}:void 0},h=function(){return a.signatures.forEach(function(b){return b.valid=b.valid(a.doc.originalHash),b.certificate.valid=!1,angular.forEach(a.certs,function(a){b.certificate.valid||(b.certificate.valid=b.certificate.isCa(a.content))})})},a.parseXML=function(b){var c;c=XMLFiesta.Document.fromXml(b),c.then(function(b){var c,d;d=b.document,a.doc=d,a.oHashValid=b.xmlOriginalHash===d.originalHash,a.signatures=d.signatures(),a.record=d.conservancyRecord||null,g(),h(),c=new Blob([d.pdfBuffer()],{type:"application/pdf"}),a.pdfUrl=URL.createObjectURL(c),a.loading=!1,a.$apply()})["catch"](function(b){var c;c="XML Format is invalid: "+b.message,a.error=c,console.error(a.error),a.$apply(),a.loading=!1})},a.$watch("upload",function(b){b&&(a.loading=!0,c(function(){a.parseXML(b.result.raw)},50))})}])}.call(this),function(){"use strict";angular.module("xmlFiestaUiApp").controller("HowCtrl",function(){})}.call(this),function(){"use strict";angular.module("xmlFiestaUiApp").controller("ConfigCtrl",["$scope","localStorageService",function(a,b){var c,d;c=function(){var c,d;a.certs=[],a.nom151Ca=[],c=b.get("rootCerts"),d=b.get("nom151Ca"),d&&angular.forEach(d,function(b){return a.nom151Ca.push(b)}),c&&angular.forEach(c,function(b){return a.certs.push(b)})},c(),a.removeNom151Ca=function(){return b.remove("nom151Ca"),c()},a.removeCerts=function(){return b.remove("rootCerts"),c()},a.clear=function(){return b.clearAll(),c()},d=function(d,e){var f;return f=b.get(e)||{},angular.forEach(d.target.files,function(d){var g;return g=new FileReader,g.addEventListener("load",function(a){return f[d.name]={name:d.name,content:a.target.result},b.set(e,f),angular.element(".cert-uploader").val("")}),g.addEventListener("loadend",function(){return c(),a.$apply()}),g.readAsText(d)})},a.setRootCerts=function(a){return d(a,"rootCerts")},a.setNom151Ca=function(a){return d(a,"nom151Ca")}}]).directive("customOnChange",function(){return{restrict:"A",link:function(a,b,c){var d;return d=a.$eval(c.customOnChange),b.bind("change",d)}}})}.call(this),function(){angular.module("xmlFiestaUiApp").directive("dropzone",[function(){return{link:function(a,b){b.bind("dragover",function(a){a.stopPropagation(),$(this).addClass("image-dropping")}).bind("dragleave",function(a){a.stopPropagation(),$(this).removeClass("image-dropping")}).bind("drop",function(a){a.stopPropagation(),$(this).removeClass("image-dropping")}),$("body").bind("dragover",function(a){a.stopPropagation(),b.addClass("image-dragging")}).bind("dragleave",function(a){a.stopPropagation(),b.removeClass("image-dragging")})}}}])}.call(this),function(){angular.module("xmlFiestaUiApp").directive("fileread",[function(){"use strict";return{scope:{fileread:"="},link:function(a,b,c){b.bind("change",function(b){var d,e,f,g,h,i;if(i=new FileReader,g=b.target.files[0],d=c.accept?c.accept.replace(".","").toLowerCase():null,e=void 0,h=void 0,f=void 0,g){if(e=c.accept===g.type,h=null!==g.type.match(d),f=g.name.substr(-3)===d,!(e||h||f))return void a.$apply(function(){a.fileread={errors:["Este tipo de archivo no está soportado, por favor sube un "+c.acceptName+"."]}});i.addEventListener("load",function(b){a.$apply(function(){var c;c=b.target.result,a.fileread={type:g.type,name:g.name,file:g,result:{data:"",hash:"",raw:c}}})}),!g||angular.isDefined(c.raw)&&"false"===c.raw||(c.binary?i.readAsBinaryString(g):c.text?i.readAsText(g):i.readAsArrayBuffer(g))}})}}}])}.call(this),angular.module("xmlFiestaUiApp").run(["$templateCache",function(a){"use strict";a.put("views/config.html",'<div class="config"> <div class="row"> <div class="col-md-12"> <div ng-show="certs.length > 0" class="proceed-verify"> <h4>{{ \'CONFIG.CERTIFICATES_LOADED\' | translate }}</h4> <button class="btn-lg btn-success" ui-sref="verify">{{ \'CONFIG.VER_BUTTON\' | translate }}</button> </div> </div> </div> <div class="row"> <div class="col-md-6"> <div class="form-group upload-certificates"> <h3>{{ \'CONFIG.SELECT\' | translate }}</h3> <p class="help-block top-padder-md">{{ \'CONFIG.ALL\' | translate }}</p> <p class="help-block top-padder-md bottom-padder-md">{{ \'CONFIG.AFTER\' | translate }}</p> <h4><strong>Carga de Certificados de firma</strong></h4> <input type="file" accept=".crt" class="cert-uploader" custom-on-change="setRootCerts" multiple> <h4><strong>Carga de Certificados de constancia</strong></h4> <input type="file" accept=".crt" class="nom151Ca-uploader" custom-on-change="setNom151Ca" multiple> </div> </div> <div class="col-md-5 col-md-offset-1"> <div ng-show="certs.length > 0 || nom151Ca.length > 0" class="root-certificates"> <div ng-show="certs.length > 0"> <h4> {{ \'CONFIG.LOADED\' | translate }} </h4> <ul class="bottom-padder-md"> <li ng-repeat="cert in certs | orderBy:\'name\'"> {{ cert.name }} </li> </ul> </div> <div ng-show="nom151Ca.length > 0"> <h4> Certificados Raíz de constancia <a href="" class="text-small text-danger unstyled glyphicon glyphicon-trash" ng-click="removeNom151Ca()"></a> </h4> <ul class="bottom-padder-md"> <li ng-repeat="cert in nom151Ca | orderBy:\'name\'"> {{ cert.name }} </li> </ul> </div> </div> <div ng-show="certs.length > 0">{{ \'CONFIG.DELETE\' | translate }}<b>{{ \'CONFIG.UNDONE\' | translate }}</b> <button ng-click="clear()" class="btn btn-md btn-delete glyphicon glyphicon-trash"></button> </div> </div> </div> </div>'),a.put("views/how.html","<div id=\"how-it-works\"> <h3>{{ 'FAQ.ABOUT' | translate }}</h3> <p>{{ 'FAQ.INTRO' | translate }}</p> <p class=\"help-block\"><em>{{ 'FAQ.NOTICE' | translate }}<a href=\"https://www.mifiel.com\">Mifiel</a></em></p> <h3 class=\"top-padder-md\">¿Cómo Funciona?</h3> <p>Para utilizarla sólo tienes que:</p> <p>{{ 'FAQ.FIRST' | translate }}</p> <p>{{ 'FAQ.SECOND' | translate }}</p> <p>{{ 'FAQ.THIRD' | translate }}</p> <h3 class=\"top-padder-md\">{{ 'FAQ.WHAT' | translate }}</h3> <p>{{ 'FAQ.VALIDATION_1' | translate }}</p> <p>{{ 'FAQ.VALIDATION_2' | translate }}</p> <p>{{ 'FAQ.VALIDATION_3' | translate }}</p> </div> <div class=\"contact\"> <object data=\"images/email.2e8137ee.svg\" type=\"image/svg+xml\" alt=\"Contáctanos\"></object> <h3>{{ 'FAQ.QUESTIONS' | translate }}</h3> <a href=\"mailto:hola@mifiel.com\" class=\"btn btn-md btn-success\">{{ 'FAQ.EMAIL' | translate }}</a> </div>"),a.put("views/main.html",'<div> <h1>Hello</h1> <p><a class="btn btn-lg btn-success" ng-href="#/">Splendid!<span class="glyphicon glyphicon-ok"></span></a></p> <img src="images/yeoman.png" alt="I\'m Yeoman"><br> </div>'),a.put("views/pdfViewer.html",'<nav class="pdf-controls" ng-class="getNavStyle(scroll)"> <span>Página </span> <span class="margin-right-sm"><b>{{pageNum}}</b> de {{pageCount}}</span> <button class="btn btn-sm btn-success" ng-click="goPrevious()">&lt;</button> <button class="btn btn-sm btn-success margin-right-sm" ng-click="goNext()">&gt;</button> <a href="{{pdfUrl}}" target="_blank">Descargar</a> </nav> <canvas id="pdf-canvas" class="rotate0"></canvas>'),a.put("views/verify.html",'<div class="verify"> <div id="instructions" ng-if="!ready"> <div class="row"> <h2>{{ \'VERIFY.TITLE\' | translate }}</h2> </div> <div class="row bottom-padder-md"> <div class="col-md-4 col-md-offset-0 col-sm-10 col-sm-offset-1 col-md-offset-0 col-sm-10 col-sm-offset-1"> <object data="images/upload_certificates.d73fe3f9.svg" type="image/svg+xml" alt="Upload Certificates"></object> <p>{{ \'VERIFY.ROOT\' | translate }}</p> </div> <div class="col-md-4 col-md-offset-0 col-sm-10 col-sm-offset-1"> <object data="images/upload_xml.68a4b24b.svg" type="image/svg+xml" alt="Upload XML"></object> <p>{{ \'VERIFY.XML\' | translate }}</p> </div> <div class="col-md-4 col-md-offset-0 col-sm-10 col-sm-offset-1"> <object data="images/verify.f956272a.svg" type="image/svg+xml" alt="Verify information"></object> <p>{{ \'VERIFY.VALIDATION\' | translate }}</p> </div> </div> <div class="row top-padder-md"> <button class="btn-lg btn-success" ui-sref="config">{{ \'VERIFY.GET_STARTED\' | translate }}</button> </div> </div> <div class="row" ng-show="ready && !pdfUrl"> <div class="upload text-center" dropzone> <div class="upload-default"> <div ng-show="!loading"> <h5 class="bottom-padder-md">{{ \'VERIFY.DRAG\' | translate }}</h5> <button class="btn">{{ \'VERIFY.SELECT\' | translate }}</button> <input accept-name="XML" accept="text/xml" text="true" class="file-upload-input" fileread="upload" required type="file"> </div> <div ng-show="loading"> <h4>{{ \'VERIFY.LOADING\' | translate }}</h4> </div> <div class="text-danger" ng-show="error"> <h4>{{ error }}</h4> </div> </div> </div> </div> <div ng-show="pdfUrl && !loading"> <h2 class="center">{{ \'VERIFY.VALIDATIONS\' | translate }}</h2> <p class="help-block">{{ \'VERIFY.REMINDER\' | translate }}</p> <div class="verify-info row top-padder-md"> <div class="col-md-3 col-sm-4"> <strong>{{ \'VERIFY.DOCUMENT_NAME\' | translate }}</strong> </div> <div class="col-md-9 col-sm-8"> {{ doc.name }} </div> <div class="col-md-3 col-sm-4" ng-class="{\'text-success\': oHashValid, \'text-danger\': !oHashValid}"> <strong>{{ \'VERIFY.ORIG_HASH\' | translate }}<i class="glyphicon" ng-class="{\'glyphicon-ok\': oHashValid, \'glyphicon-remove\': !oHashValid}"></i></strong> </div> <div class="col-md-9 col-sm-8"> {{ doc.originalHash }} <a href="" ng-show="!oHashValid" ng-click="showOHashError = !showOHashError">{{ \'VERIFY.WHY\' | translate }}</a> <p class="alert alert-danger alert-incorrect" ng-show="showOHashError" role="alert"> {{ \'VERIFY.WRONG_HASH\' | translate }} </p> </div> </div> <div class="verify-info row top-padder-md" id="signers" ng-repeat="signature in signatures"> <div class="col-md-3 col-sm-4"> <strong>{{ \'VERIFY.SIGNER\' | translate }}</strong> </div> <div class="col-md-9 col-sm-8"> {{ signature.signer.name }} &lt;{{ signature.signer.email }}&gt; </div> <div class="col-md-3 col-sm-4"> <strong>{{ \'VERIFY.ID\' | translate }}</strong> </div> <div class="col-md-9 col-sm-8"> {{ signature.signer.id }} </div> <div class="col-md-3 col-sm-4"> <strong>{{ \'VERIFY.SIG_DATE\' | translate }}</strong> </div> <div class="col-md-9 col-sm-8"> {{ signature.signedAt | date:\'medium\':\'UTC\' }} </div> <div class="col-md-3 col-sm-4" ng-class="{\'text-success\': signature.certificate.valid, \'text-danger\': !signature.certificate.valid}"> <strong>{{ \'VERIFY.CERT_NUMBER\' | translate }}<i class="glyphicon" ng-class="{\'glyphicon-ok\': signature.certificate.valid, \'glyphicon-remove\': !signature.certificate.valid}"></i></strong> </div> <div class="col-md-9 col-sm-8"> {{ signature.certificate.getSerialNumber() }} <a href="" ng-show="!signature.certificate.valid" ng-click="signature.showCertError = !signature.showCertError">{{ \'VERIFY.WHY\' | translate }}</a> <p class="alert alert-danger alert-incorrect" ng-show="signature.showCertError" role="alert"> {{ \'VERIFY.WRONG_CERT\' | translate }} </p> </div> <div class="col-md-3 col-sm-4" ng-class="{\'text-success\': signature.valid, \'text-danger\': !signature.valid}"> <strong>{{ \'VERIFY.SIGNATURE\' | translate }}<i class="glyphicon" ng-class="{\'glyphicon-ok\': signature.valid, \'glyphicon-remove\': !signature.valid}"></i></strong> </div> <div class="col-md-9 col-sm-8 text-break"> <p>{{ signature.sig(\'base64\') }}</p> <a href="" ng-show="!signature.valid" ng-click="signature.showValidError = !signature.showValidError">{{ \'VERIFY.WHY\' | translate }}</a> <p class="alert alert-danger alert-incorrect" ng-show="signature.showValidError" role="alert"> {{ \'VERIFY.WRONG_SIG\' | translate }} </p> </div> </div> <div ng-show="record" class="verify-info row top-padder-md" id="conservancy-record"> <div class="col-md-12" ng-class="{\'text-danger\': !record.valid}"> <strong> {{ \'VERIFY.CONSERVANCY_RECORD\' | translate }} <i class="glyphicon" ng-class="{\'glyphicon-remove\': !record.valid}"></i> </strong> <a ng-show="!record.valid" href="" ng-click="record.showValidCR = !record.showValidCR">{{ \'VERIFY.WHY\' | translate }}</a> <p class="alert alert-danger alert-incorrect" ng-show="record.showValidCR" role="alert"> {{ \'VERIFY.RECORD.WRONG_CR\' | translate }} </p> </div> <div ng-show="record.valid"> <div class="col-md-3 col-sm-4" ng-class="{\'text-success\': record.validCA, \'text-danger\': !record.validCA}"> <strong>{{ \'VERIFY.RECORD.ISSUER\' | translate }}</strong> <i class="glyphicon" ng-class="{\'glyphicon-ok\': record.validCA, \'glyphicon-remove\': !record.validCA}"></i> </div> <div class="col-md-9 col-sm-8"> {{ record.caName() }} </div> <div class="col-md-3 col-sm-4" ng-class="{\'text-success\': record.validTS, \'text-danger\': !record.validTS}"> <strong> {{ \'VERIFY.RECORD.TIMESTAMP\' | translate }} <i class="glyphicon" ng-class="{\'glyphicon-ok\': record.validTS, \'glyphicon-remove\': !record.validTS}"></i> </strong> </div> <div class="col-md-9 col-sm-8"> {{ record.recordTimestamp() | date:\'medium\':\'UTC\' }} <a href="" ng-show="!record.validTS" ng-click="record.showValidTS = !record.showValidTS">{{ \'VERIFY.WHY\' | translate }}</a> <p class="alert alert-danger alert-incorrect" ng-show="record.showValidTS" role="alert"> {{ \'VERIFY.RECORD.WRONG_TS\' | translate:record.tsTranslation }} </p> </div> <div class="col-md-3 col-sm-4" ng-class="{\'text-success\': record.validArchive, \'text-danger\': !record.validArchive}"> <strong> {{ \'VERIFY.RECORD.VALIDITY\' | translate }} <i class="glyphicon" ng-class="{\'glyphicon-ok\': record.validArchive, \'glyphicon-remove\': !record.validArchive}"></i> </strong> </div> <div class="col-md-9 col-sm-8"> <p ng-show="!record.validArchive"> {{ \'VERIFY.RECORD.WRONG_ARCHIVE\' | translate }} </p> <p ng-show="record.validArchive"> {{ \'VERIFY.RECORD.VALID_ARCHIVE\' | translate }} </p> </div> </div> </div> <div class="row top-padder-md bottom-padder-md center"> <p><strong>{{ \'VERIFY.REVIEW\' | translate }}</strong></p> </div> <div class="row bottom-padder-lg center"> <button class="btn-lg btn-success" ng-click="clear()">{{ \'VERIFY.NEW_DOC\' | translate }}</button> </div> <hr> <div id="pdf-container" class="center top-padder-md"> <ng-pdf template-url="views/pdfViewer.html"></ng-pdf> </div> </div> </div>')}]);